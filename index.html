<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Font → Letterpress STL — Clean Build</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap">
<style>
  :root{--bg:#0f1724;--card:#0b1220;--muted:#9aa4b2;--accent:#7c3aed}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#071024 0%,#091426 100%);font-family:Inter,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial}
  .app{max-width:1200px;margin:28px auto;padding:18px;color:#e6eef8}
  header{display:flex;align-items:center;gap:16px}
  h1{margin:0;font-size:20px}
  .grid{display:grid;grid-template-columns:320px 1fr;gap:18px;margin-top:18px}
  .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.04);padding:14px;border-radius:12px}
  label{display:block;font-size:13px;color:var(--muted);margin-top:10px}
  input[type=text], input[type=number], select{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
  .row{display:flex;gap:8px;align-items:center}
  button{background:var(--accent);border:none;color:white;padding:8px 10px;border-radius:8px;cursor:pointer}
  button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06)}
  #viewer{height:640px;border-radius:10px;overflow:hidden}
  .glyph-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:6px;max-height:420px;overflow:auto;margin-top:10px}
  .glyph-cell{background:rgba(255,255,255,0.02);padding:8px;border-radius:6px;display:flex;align-items:center;justify-content:center;cursor:pointer}
  .glyph-cell.active{outline:2px solid rgba(124,58,237,0.6)}
  .small{font-size:12px;color:var(--muted)}
  footer{margin-top:12px;color:var(--muted);font-size:13px}
  .flex{display:flex;gap:8px}
  .controls{display:flex;flex-direction:column;gap:8px}
  #viewer canvas{width:100%;height:100%;display:block}
    .info-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px;margin-top:12px}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;background:rgba(255,255,255,0.04);color:#cbd5e1;font-size:12px}
  .pill svg{width:14px;height:14px}
    .info-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px;margin-top:12px}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;background:rgba(255,255,255,0.04);color:#cbd5e1;font-size:12px}
  .pill svg{width:14px;height:14px}
</style>
</head>
<body>
<div class="app">
  <header>
    <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='44' height='44'><rect rx='8' width='44' height='44' fill='%237c3aed'/><text x='50%' y='56%' font-size='20' font-family='sans-serif' fill='white' text-anchor='middle' alignment-baseline='middle'>DT</text></svg>" alt="logo" style="width:44px;height:44px;border-radius:8px">
    <div>
      <h1>Font → Letterpress STL (Clean Build)</h1>
      <div class="small">Upload fonts, preview glyphs, add backs, mirror, and batch-export STLs.</div>
    </div>
  </header>
  <div class="grid">
    <!-- Left column: controls -->
    <div class="card">
      <label>Drag & drop or choose a font (.ttf, .otf)</label>
      <div id="drop" style="border:2px dashed rgba(255,255,255,0.04);padding:12px;border-radius:8px;cursor:pointer">Drop font here or <input id="file" type="file" accept=".ttf,.otf" style="display:inline-block;margin-left:6px"></div>
       <label style="margin-top:12px">Or try a preset web font (no upload)</label>
      <div class="row">
        <select id="presetFont">
          <option value="merriweathersans">Merriweather Sans (Google Fonts)</option>
          <option value="inter">Inter (Google Fonts)</option>
        </select>
        <button id="loadPreset">Load</button>
      </div>
      <div class="small">Useful for quick STL trials without a local font file.</div>
      <div class="meta" style="margin-top:10px">
        <div class="small">Loaded: <span id="fontName">—</span></div>
        <div class="small">Glyphs: <span id="glyphCount">0</span></div>
      </div>

      <label>Glyph selector (click to preview)</label>
      <div id="glyphList" class="glyph-grid card" style="padding:8px;background:transparent"></div>

        <label><input id="mirror" type="checkbox"> Mirror horizontally</label>

        <label>Add rectangular flat back</label>
        <label><input id="addBack" type="checkbox" checked> Add back</label>

        <div class="row">
          <button id="build">Build Preview</button>
          <button id="export" class="ghost" disabled>Export Selected STL</button>
          <button id="exportAll" class="ghost" disabled>Export All Glyphs (ZIP)</button>
        </div>

        <div class="small">Tip: "Inset stroke" approximates an engraved stroke by adding a scaled inner extrusion — for exact boolean engraving use a mesh editor (Blender).</div>
      </div>
    </div>

    <!-- Right column: viewer -->
    <div>
      <div class="card" id="viewer"></div>
      <div style="display:flex;gap:10px;margin-top:8px;align-items:center;justify-content:space-between">
        <div class="small">Preview controls: rotate, pan, zoom. Center & reset camera after building.</div>
        <div><button id="resetCam" class="ghost">Reset View</button></div>
      </div>
    </div>
  </div>

   <div class="info-grid">
    <div class="card">
      <div class="pill" title="Why this exists">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 3l7 4v6c0 4-3 7-7 8-4-1-7-4-7-8V7l7-4z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
        Inspired by craft-forward 3D letterpress tooling.
      </div>
      <h3 style="margin:10px 0 6px">Purpose-built for printable type</h3>
      <p class="small">Upload any .ttf or .otf and instantly preview glyph geometry in 3D. Mirror the build for letterpress, add a rectangular backer for easier mounting, and export single glyphs or the entire alphabet as ready-to-fix STL meshes.</p>
    </div>

    <div class="card">
      <div class="pill" title="Workflow">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7 8h10M7 12h10M7 16h6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
        Quick start
      </div>
      <ol class="small" style="margin:10px 0 0 16px; padding:0 0 0 4px; display:grid; gap:6px">
        <li>Drop a font file or use the picker to load glyphs.</li>
        <li>Select a glyph tile or type a short word to preview.</li>
        <li>Choose type height, extrusion depth, optional inset, and mirror for letterpress.</li>
        <li>Click <strong>Build Preview</strong> to rebuild the mesh, then export the selected glyph or a ZIP of all glyphs.</li>
      </ol>
    </div>

    <div class="card">
      <div class="pill" title="Print tips">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
        Print notes
      </div>
      <ul class="small" style="margin:10px 0 0 16px; padding:0 0 0 4px; display:grid; gap:6px">
        <li>Exported meshes are flat STL solids; run through a mesh fixer or slicer if you need manifold validation.</li>
        <li>Type height defaults to 0.918&quot; (23.3&nbsp;mm). Use the drop-down to match your press bed or resin shrink.</li>
        <li>"Inset stroke" adds a lightly engraved inner pass for visual checking—use a CAD boolean if you need perfect counters.</li>
      </ul>
    </div>
  </div>

  <footer>
    Built to mimic DigitalTypeFoundry-style previews. Exports plain STLs — run through a slicer or mesh fixer if needed for printability.
  </footer>
</div>

<!-- Libraries -->
<script src="https://unpkg.com/opentype.js@1.3.4/dist/opentype.min.js"></script>
<script type="module">
// Correct ESM imports (no bare specifiers)
import * as THREE from 'https://unpkg.com/three@0.164.1/build/three.module.js';
import { OrbitControls } from 'https://unpkg.com/three@0.164.1/examples/jsm/controls/OrbitControls.js';
import { STLExporter } from 'https://unpkg.com/three@0.164.1/examples/jsm/exporters/STLExporter.js';
import JSZip from 'https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.esm.min.js';
import { BufferGeometryUtils } from 'https://unpkg.com/three@0.164.1/examples/jsm/utils/BufferGeometryUtils.js';

// DOM
const fileInput = document.getElementById('file');
const drop = document.getElementById('drop');
const fontNameEl = document.getElementById('fontName');
const glyphList = document.getElementById('glyphList');
const glyphCountEl = document.getElementById('glyphCount');
const buildBtn = document.getElementById('build');
const exportBtn = document.getElementById('export');
const exportAllBtn = document.getElementById('exportAll');
const textPreview = document.getElementById('textPreview');
const depthInput = document.getElementById('depth');
const mirrorChk = document.getElementById('mirror');
const addBackChk = document.getElementById('addBack');
const insetInput = document.getElementById('inset');
const baselineInput = document.getElementById('baseline');
const heightPreset = document.getElementById('heightPreset');
const viewer = document.getElementById('viewer');
const resetCamBtn = document.getElementById('resetCam');
const presetFont = document.getElementById('presetFont');
const loadPresetBtn = document.getElementById('loadPreset');
const persistentControls = [heightPreset, depthInput, baselineInput, insetInput, mirrorChk, addBackChk];
let loadedFont = null;
let glyphs = [];
let previewObject = null;
const presetFonts = {
  merriweathersans: {
    url: 'https://cdn.jsdelivr.net/gh/google/fonts/ofl/merriweathersans/MerriweatherSans-Regular.ttf',
    label: 'Merriweather Sans Regular'
  },
  inter: {
    url: 'https://cdn.jsdelivr.net/gh/google/fonts/ofl/inter/Inter-Regular.ttf',
    label: 'Inter Regular'
  }
};
// THREE setup
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x0b1220);
const camera = new THREE.PerspectiveCamera(45, viewer.clientWidth / viewer.clientHeight, 0.1, 2000);
camera.position.set(0, 120, 260);
const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(viewer.clientWidth, viewer.clientHeight);
viewer.appendChild(renderer.domElement);
const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;

const hemi = new THREE.HemisphereLight(0xffffff, 0x444444, 0.8); scene.add(hemi);
const dir = new THREE.DirectionalLight(0xffffff, 0.6); dir.position.set(100,200,100); scene.add(dir);
const grid = new THREE.GridHelper(400, 40, 0x111827, 0x0b1220); grid.material.opacity = 0.12; grid.material.transparent = true; scene.add(grid);

let previewGroup = new THREE.Group(); scene.add(previewGroup);

function animate(){ requestAnimationFrame(animate); controls.update(); renderer.render(scene, camera); }
animate();

restoreSettings();
persistentControls.forEach(ctrl=>{
  ctrl.addEventListener('change', ()=>{ saveSettings(); });
  ctrl.addEventListener('input', ()=>{ saveSettings(); });
});

window.addEventListener('resize', ()=>{ renderer.setSize(viewer.clientWidth, viewer.clientHeight); camera.aspect = viewer.clientWidth / viewer.clientHeight; camera.updateProjectionMatrix(); });

function saveSettings(){
  const payload = {
    heightPreset: heightPreset.value,
    depth: depthInput.value,
    baseline: baselineInput.value,
    inset: insetInput.value,
    mirror: mirrorChk.checked,
    addBack: addBackChk.checked
  };
  localStorage.setItem('fontToStlSettings', JSON.stringify(payload));
}

function restoreSettings(){
  try{
    const stored = localStorage.getItem('fontToStlSettings');
    if(!stored) return;
    const data = JSON.parse(stored);
    if(data.heightPreset) heightPreset.value = data.heightPreset;
    if(data.depth) depthInput.value = data.depth;
    if(data.baseline) baselineInput.value = data.baseline;
    if(data.inset) insetInput.value = data.inset;
    if(typeof data.mirror === 'boolean') mirrorChk.checked = data.mirror;
    if(typeof data.addBack === 'boolean') addBackChk.checked = data.addBack;
  }catch(err){ console.warn('Unable to restore settings', err); }
}

// File handling + drag/drop
fileInput.addEventListener('change', async (e)=>{ if(e.target.files && e.target.files[0]) await loadFontFile(e.target.files[0]); });
['dragenter','dragover'].forEach(ev=>drop.addEventListener(ev,e=>{ e.preventDefault(); drop.style.borderColor='rgba(124,58,237,0.7)'; }));
['dragleave','drop'].forEach(ev=>drop.addEventListener(ev,e=>{ e.preventDefault(); drop.style.borderColor='rgba(255,255,255,0.04)'; }));
drop.addEventListener('drop', async (e)=>{ if(e.dataTransfer.files && e.dataTransfer.files[0]) await loadFontFile(e.dataTransfer.files[0]); });
loadPresetBtn.addEventListener('click', async ()=>{
  const choice = presetFont.value;
  const cfg = presetFonts[choice];
  if(!cfg) return;
  await loadFontFromUrl(cfg.url, cfg.label);
});
async function loadFontFile(file){
  try{
    const ab = await file.arrayBuffer();
        await loadFontBuffer(ab, file.name);
  }catch(err){ console.error(err); alert('Failed to load font: '+err.message); }
}
async function loadFontFromUrl(url, label){
  try{
    const res = await fetch(url);
    if(!res.ok) throw new Error('HTTP '+res.status);
    const ab = await res.arrayBuffer();
    await loadFontBuffer(ab, label || url);
  }catch(err){ console.error(err); alert('Failed to load web font: '+err.message); }
}

async function loadFontBuffer(ab, displayName){
  loadedFont = opentype.parse(ab);
  fontNameEl.textContent = (loadedFont.names && loadedFont.names.fullName && loadedFont.names.fullName.en) ? loadedFont.names.fullName.en : displayName;
  glyphs = loadedFont.glyphs.glyphs.filter(g=>g.unicode!==undefined);
  glyphList.innerHTML = '';
  glyphs.forEach((g,i)=>{
    const span = document.createElement('div'); span.className='glyph-cell';
    span.innerHTML = '<div style="font-size:20px;line-height:1">'+String.fromCharCode(g.unicode)+'</div>';
    span.title = g.name || ('U+'+g.unicode.toString(16));
    span.addEventListener('click', ()=>{ selectGlyph(i); });
    glyphList.appendChild(span);
  });
  glyphCountEl.textContent = glyphs.length;
  if(glyphs.length>0){ selectGlyph(0); exportAllBtn.disabled=false; }
}
function selectGlyph(i){
  Array.from(glyphList.children).forEach((el,idx)=>el.classList.toggle('active', idx===i));
  const ch = String.fromCharCode(glyphs[i].unicode);
  textPreview.value = ch; buildPreview(); exportBtn.disabled=false;
}

// Convert opentype path to THREE.Shape(s). This version is robust and handles holes.
function pathToShapes(path){
  const commands = path.commands;
  const contours = [];
  let current = [];
  commands.forEach(cmd=>{
    if(cmd.type==='M'){
      if(current.length) contours.push(current);
      current = [{type:'M', x:cmd.x, y:cmd.y}];
    } else if(cmd.type==='L'){
      current.push({type:'L', x:cmd.x, y:cmd.y});
    } else if(cmd.type==='C'){
      current.push({type:'C', x:cmd.x, y:cmd.y, x1:cmd.x1, y1:cmd.y1, x2:cmd.x2, y2:cmd.y2});
    } else if(cmd.type==='Q'){
      current.push({type:'Q', x:cmd.x, y:cmd.y, x1:cmd.x1, y1:cmd.y1});
    } else if(cmd.type==='Z'){
      // close
    }
  });
